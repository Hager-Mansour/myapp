name: CI Pipeline

on:
  push:
    branches:
      - hager-ci

jobs:
  docker-pipeline:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout Repo
      uses: actions/checkout@v4


    # ---------------- BUILD ----------------

    - name: Build Docker Image
      run: |
        docker build -t myapp:latest .


    # ---------------- SCAN ----------------

    - name: Trivy Scan (JSON Report)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: myapp:latest
        format: json
        output: trivy-report.json
        exit-code: 0


    - name: Upload Trivy Report
      uses: actions/upload-artifact@v4
      with:
        name: trivy-report
        path: trivy-report.json


    # ---------------- DEBUG SECRET ----------------

    - name: Debug Docker Username
      run: |
        echo "Docker User => ${{ secrets.DOCKER_USER }}"


    # ---------------- LOGIN ----------------

    - name: DockerHub Login
      run: |
        echo "${{ secrets.DOCKER_PASS }}" | docker login -u "${{ secrets.DOCKER_USER }}" --password-stdin


    # ---------------- PUSH ----------------

    - name: Tag Image
      run: |
        docker tag myapp:latest ${{ secrets.DOCKER_USER }}/myapp:ci


    - name: Push Image To DockerHub
      run: |
        docker push ${{ secrets.DOCKER_USER }}/myapp:ci
